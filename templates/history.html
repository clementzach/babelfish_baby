{% extends "base.html" %}

{% block title %}Cry History - BabelFish Baby{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>üçº BabelFish Baby</h1>
        <div class="header-actions">
            <a href="/record" class="btn-record">üìπ Record New Cry</a>
            <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
    </div>

    <!-- Banner for new users -->
    <div id="newUserBanner" class="banner" style="display: none;">
        <strong>üëã Welcome!</strong> <span id="bannerMessage"></span>
    </div>

    <!-- Cry list -->
    <div id="cryList" class="cry-list">
        <!-- Will be populated by JavaScript -->
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <h2>No recordings yet</h2>
        <p>Click "Record New Cry" to get started!</p>
        <a href="/record" class="btn-record" style="margin-top: 20px; display: inline-block;">üìπ Record New Cry</a>
    </div>

    <!-- Loading state -->
    <div id="loadingState" class="processing" style="text-align: center; padding: 40px;">
        <div class="spinner"></div>
        <p>Loading your cry history...</p>
    </div>
</div>

<!-- Modal for labeling/editing -->
<div id="labelModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2 id="modalTitle">Label Cry</h2>
        <form id="labelForm">
            <input type="hidden" id="labelCryId">

            <div class="form-group">
                <label for="reasonInput">Why was baby crying?</label>
                <input type="text" id="reasonInput" list="reasonSuggestions" placeholder="e.g., hungry, tired, dirty diaper..." required>
                <datalist id="reasonSuggestions">
                    <option value="Hungry">
                    <option value="Tired">
                    <option value="Dirty diaper">
                    <option value="Pain or discomfort">
                    <option value="Needs comfort">
                    <option value="Overstimulated">
                    <option value="Other">
                </datalist>
            </div>

            <div class="form-group">
                <label for="solutionInput">What helped? (optional)</label>
                <input type="text" id="solutionInput" list="solutionSuggestions" placeholder="e.g., fed bottle, rocked to sleep...">
                <datalist id="solutionSuggestions">
                    <option value="Fed bottle">
                    <option value="Breastfed">
                    <option value="Changed diaper">
                    <option value="Rocked to sleep">
                    <option value="Cuddled">
                    <option value="Changed environment">
                    <option value="Gave pacifier">
                </datalist>
            </div>

            <div class="form-group">
                <label for="notesInput">Notes (optional)</label>
                <textarea id="notesInput" rows="3" maxlength="500" placeholder="Additional details..."></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" id="cancelBtn" class="btn-small btn-reject">Cancel</button>
                <button type="submit" class="btn-small btn-validate">Save</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cries = [];
let validatedCount = 0;
const REQUIRED_VALIDATIONS = 5;

// Load data on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadCries();
});

// Logout handler
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/';
    } catch (error) {
        showNotification('Logout failed', 'error');
    }
});

// Load cry history
async function loadCries() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('cryList').style.display = 'none';

    try {
        const response = await fetch('/api/cries/history');
        cries = await response.json();

        document.getElementById('loadingState').style.display = 'none';

        if (cries.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
        } else {
            document.getElementById('cryList').style.display = 'flex';
            renderCries();
            checkNewUserBanner();
        }
    } catch (error) {
        document.getElementById('loadingState').style.display = 'none';
        showNotification('Failed to load cry history', 'error');
    }
}

// Check if user needs to see banner
function checkNewUserBanner() {
    validatedCount = cries.filter(c => c.validation_status === true).length;

    if (validatedCount < REQUIRED_VALIDATIONS) {
        const remaining = REQUIRED_VALIDATIONS - validatedCount;
        const bannerEl = document.getElementById('newUserBanner');
        const messageEl = document.getElementById('bannerMessage');

        if (remaining === REQUIRED_VALIDATIONS) {
            messageEl.textContent = `Please label ${REQUIRED_VALIDATIONS} recordings to activate AI predictions.`;
        } else if (remaining === 1) {
            messageEl.textContent = `Label 1 more recording to activate AI predictions!`;
        } else {
            messageEl.textContent = `Label ${remaining} more recordings to activate AI predictions.`;
        }

        bannerEl.style.display = 'block';
    }
}

// Render cry list
function renderCries() {
    const listEl = document.getElementById('cryList');
    listEl.innerHTML = '';

    cries.forEach(cry => {
        const item = createCryItem(cry);
        listEl.appendChild(item);
    });
}

// Create a cry item element
function createCryItem(cry) {
    const div = document.createElement('div');
    div.className = 'cry-item';
    div.dataset.cryId = cry.cry_id;

    // Header with time and reason
    const header = document.createElement('div');
    header.className = 'cry-header';

    const time = document.createElement('span');
    time.className = 'cry-time';
    time.textContent = cry.recorded_at_relative;
    time.title = cry.recorded_at;
    header.appendChild(time);

    // Determine what to show for reason
    if (cry.reason && cry.validation_status === true) {
        // User-validated reason
        const reasonBadge = document.createElement('span');
        reasonBadge.className = 'cry-reason';
        reasonBadge.textContent = cry.reason;
        header.appendChild(reasonBadge);
    } else if (cry.ai_reason) {
        // AI prediction available
        const reasonBadge = document.createElement('span');
        reasonBadge.className = 'cry-reason ai-prediction';
        reasonBadge.textContent = `ü§ñ ${cry.ai_reason}`;
        reasonBadge.title = 'AI Prediction - Please validate';
        header.appendChild(reasonBadge);
    } else if (validatedCount >= REQUIRED_VALIDATIONS && !cry.reason) {
        // AI enabled but prediction pending
        const reasonBadge = document.createElement('span');
        reasonBadge.className = 'cry-reason ai-pending';
        reasonBadge.textContent = `ü§ñ AI suggestion pending`;
        reasonBadge.title = 'AI is analyzing this recording...';
        header.appendChild(reasonBadge);
    }

    div.appendChild(header);

    // Solution (if provided)
    if (cry.solution && cry.validation_status === true) {
        const solutionDiv = document.createElement('div');
        solutionDiv.className = 'cry-solution';
        solutionDiv.textContent = `‚úì ${cry.solution}`;
        div.appendChild(solutionDiv);
    } else if (cry.ai_solution) {
        const solutionDiv = document.createElement('div');
        solutionDiv.className = 'cry-solution ai-prediction';
        solutionDiv.textContent = `ü§ñ ${cry.ai_solution}`;
        solutionDiv.title = 'AI Prediction - Please validate';
        div.appendChild(solutionDiv);
    }

    // Notes
    if (cry.notes) {
        const notes = document.createElement('div');
        notes.className = 'cry-notes';
        notes.textContent = cry.notes;
        div.appendChild(notes);
    }

    // Audio player (if audio exists)
    if (cry.has_audio) {
        const audioContainer = document.createElement('div');
        audioContainer.className = 'audio-player-container';
        audioContainer.style.marginTop = '10px';

        const audio = document.createElement('audio');
        audio.controls = true;
        audio.preload = 'none';
        audio.src = `/api/cries/${cry.cry_id}/audio`;
        audio.style.width = '100%';
        audio.style.maxWidth = '400px';

        audioContainer.appendChild(audio);
        div.appendChild(audioContainer);
    }

    // Photo thumbnail (if photo exists)
    if (cry.has_photo) {
        const photoContainer = document.createElement('div');
        photoContainer.className = 'photo-thumbnail-container';
        photoContainer.style.marginTop = '10px';

        const img = document.createElement('img');
        img.src = `/api/cries/${cry.cry_id}/photo`;
        img.alt = 'Baby photo';
        img.className = 'photo-thumbnail';
        img.style.maxWidth = '150px';
        img.style.maxHeight = '150px';
        img.style.borderRadius = '8px';
        img.style.border = '2px solid #ddd';
        img.style.cursor = 'pointer';
        img.onclick = () => {
            // Open full size in new tab
            window.open(`/api/cries/${cry.cry_id}/photo`, '_blank');
        };

        photoContainer.appendChild(img);
        div.appendChild(photoContainer);
    }

    // Status indicators and Actions
    const actions = document.createElement('div');
    actions.className = 'cry-actions';

    // Check if has AI prediction awaiting validation
    if (cry.ai_reason && cry.ai_solution && cry.validation_status === null) {
        // Add validate/reject buttons
        const correctBtn = document.createElement('button');
        correctBtn.className = 'btn-small btn-validate';
        correctBtn.textContent = '‚úì Accept';
        correctBtn.onclick = () => validateAIPrediction(cry.cry_id);
        actions.appendChild(correctBtn);

        const wrongBtn = document.createElement('button');
        wrongBtn.className = 'btn-small btn-reject';
        wrongBtn.textContent = '‚úó Edit';
        wrongBtn.onclick = () => openLabelModal(cry, true);
        actions.appendChild(wrongBtn);
    }
    // Check if needs initial labeling (only show if user has < 5 validated)
    else if (!cry.reason && !cry.ai_reason && validatedCount < REQUIRED_VALIDATIONS) {
        const badge = document.createElement('div');
        badge.className = 'banner';
        badge.style.marginTop = '10px';
        badge.style.padding = '8px';
        badge.textContent = '‚ö†Ô∏è Needs Labeling';
        div.appendChild(badge);

        const labelBtn = document.createElement('button');
        labelBtn.className = 'btn-small btn-validate';
        labelBtn.textContent = 'Label';
        labelBtn.onclick = () => openLabelModal(cry);
        actions.appendChild(labelBtn);
    }
    // If AI is pending (user has ‚â•5 validated but no AI prediction yet)
    else if (!cry.reason && !cry.ai_reason && validatedCount >= REQUIRED_VALIDATIONS) {
        // No action buttons needed - AI is processing
        // The "AI suggestion pending" badge is already shown in the header
    }

    const editBtn = document.createElement('button');
    editBtn.className = 'btn-small btn-edit';
    editBtn.textContent = 'Edit';
    editBtn.onclick = () => openEditModal(cry);
    actions.appendChild(editBtn);

    // Get Advice button
    const adviceBtn = document.createElement('button');
    adviceBtn.className = 'btn-small btn-advice';
    adviceBtn.textContent = 'üí¨ Get Advice';
    adviceBtn.onclick = () => window.location.href = `/chat/${cry.cry_id}`;
    actions.appendChild(adviceBtn);

    div.appendChild(actions);

    return div;
}

// Open label modal
function openLabelModal(cry, isCorrection = false) {
    document.getElementById('modalTitle').textContent = isCorrection ? 'Correct Prediction' : 'Label Cry';
    document.getElementById('labelCryId').value = cry.cry_id;
    document.getElementById('reasonInput').value = cry.reason || '';
    document.getElementById('solutionInput').value = cry.solution || '';
    document.getElementById('notesInput').value = cry.notes || '';
    document.getElementById('reasonInput').disabled = false;
    document.getElementById('solutionInput').disabled = false;
    document.getElementById('labelModal').style.display = 'flex';
}

// Open edit modal
function openEditModal(cry) {
    document.getElementById('modalTitle').textContent = 'Edit Cry Details';
    document.getElementById('labelCryId').value = cry.cry_id;
    document.getElementById('reasonInput').value = cry.reason || '';
    document.getElementById('solutionInput').value = cry.solution || '';
    document.getElementById('notesInput').value = cry.notes || '';
    document.getElementById('reasonInput').disabled = false;
    document.getElementById('solutionInput').disabled = false;
    document.getElementById('labelModal').style.display = 'flex';
}

// Close modal
document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('labelModal').style.display = 'none';
    document.getElementById('reasonInput').disabled = false;
    document.getElementById('solutionInput').disabled = false;
});

// Submit label form
document.getElementById('labelForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const cryId = document.getElementById('labelCryId').value;
    const reason = document.getElementById('reasonInput').value;
    const solution = document.getElementById('solutionInput').value;
    const notes = document.getElementById('notesInput').value;

    try {
        // Update cry with reason, solution, and notes
        await fetch(`/api/cries/${cryId}/update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                reason: reason || null,
                solution: solution || null,
                notes: notes || null,
                validation: false
            })
        });

        document.getElementById('labelModal').style.display = 'none';
        document.getElementById('reasonInput').disabled = false;
        document.getElementById('solutionInput').disabled = false;
        showNotification('Saved successfully', 'success');
        await loadCries();
    } catch (error) {
        showNotification('Failed to save', 'error');
    }
});

// Validate cry as correct
async function validateCry(cryId, isCorrect) {
    try {
        await fetch(`/api/cries/${cryId}/update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ validation: true })
        });

        showNotification('Validation saved', 'success');
        await loadCries();
    } catch (error) {
        showNotification('Failed to validate', 'error');
    }
}

// Validate AI prediction (copies AI values to actual values)
async function validateAIPrediction(cryId) {
    try {
        await fetch(`/api/cries/${cryId}/update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ validation: true })
        });

        showNotification('AI prediction accepted!', 'success');
        await loadCries();
    } catch (error) {
        showNotification('Failed to validate AI prediction', 'error');
    }
}
</script>

<style>
/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
}

.modal-content h2 {
    margin-bottom: 20px;
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1em;
}

input[type="text"]:focus, textarea:focus {
    outline: none;
    border-color: #4A90E2;
}

.cry-reason {
    background-color: #4A90E2;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.9em;
    font-weight: 500;
}

.cry-reason.ai-prediction {
    background-color: #9C27B0;
    border: 2px dashed #7B1FA2;
}

.cry-reason.ai-pending {
    background-color: #FF9800;
    color: white;
    font-style: italic;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.cry-solution {
    color: #4CAF50;
    font-size: 0.9em;
    margin-top: 5px;
    font-weight: 500;
}

.cry-solution.ai-prediction {
    color: #9C27B0;
    font-style: italic;
}

.audio-player-container {
    margin: 10px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.audio-player-container audio {
    width: 100%;
    max-width: 400px;
    height: 40px;
    outline: none;
}

.audio-player-container audio::-webkit-media-controls-panel {
    background-color: #ffffff;
    border-radius: 4px;
}
</style>
{% endblock %}
